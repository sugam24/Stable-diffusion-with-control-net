================================================================================
REFERENCE IMAGE: SIGNIFICANCE AND USE IN CONTROLNET
================================================================================
Detailed technical explanation for project report. Includes LaTeX snippet at end.

--------------------------------------------------------------------------------
1. THE PROBLEM THE REFERENCE IMAGE SOLVES
--------------------------------------------------------------------------------

1.1 Context
----------
The pipeline transforms satellite imagery into "smart city" style: planned
layout, modern buildings, green roofs, solar panels, boulevards, etc. It uses
Stable Diffusion inpainting conditioned by multiple ControlNets (Canny,
Segmentation, and optionally Depth). The user supplies:
  - An input image (--image): the satellite view to transform.
  - A segmentation mask (--mask): labels for each pixel (Residential Area,
    Road, River, Forest, Unused Land, Agricultural Area).

Editable classes (Residential Area, Unused Land, Agricultural Area) are
regenerated by the model; immutable classes (Road, River, Forest) are
preserved exactly from the input image via compositing.

1.2 The Conflict Without a Reference Image
------------------------------------------
Originally, structural guidance for ControlNet (Canny edges and depth) was
taken from the same image that was being edited — the input image. That
creates a fundamental conflict when the input shows an unplanned or informal
area:

  - Canny ControlNet is conditioned on the input image's edges. So the model
    is told: "reproduce these edges" (chaotic streets, irregular blocks,
    organic boundaries).
  - The text prompt says: "planned city, grid layout, wide boulevards, modern
    buildings."
  - The diffusion process is thus pulled in two directions: preserve the
    unplanned geometry (from ControlNet) and overwrite it with a planned
    layout (from the prompt). The result is often:
    * Weak or inconsistent geometry — layout neither fully planned nor fully
      preserved.
    * Muddy or unconvincing details — the model cannot settle on a clear
      structure.
    * Outputs that do not match the desired "planned city" layout.

1.3 The Solution: Decoupling Structure from the Input
-----------------------------------------------------
The reference image decouples "where to edit" from "what structure to follow."

  - The input image and mask still define:
    * Which pixels to change (editable classes) and which to keep (immutable
      classes).
    * The spatial layout of classes for the Segmentation ControlNet (where
      roads, buildings, water, etc. sit in the scene).
    * The base canvas for inpainting and the source of preserved pixels in
      the final composite.
  - The reference image supplies only the desired structural blueprint for
    Canny (and optionally Depth) ControlNet: edges and depth of a planned
    city (e.g. Barcelona Eixample–style grid). The model is no longer asked
    to preserve the input's chaotic geometry; it is asked to follow the
    reference's ordered layout while still respecting the input mask's
    editable/immutable regions and class layout from the Segmentation
    ControlNet.

--------------------------------------------------------------------------------
2. SIGNIFICANCE OF THE REFERENCE IMAGE
--------------------------------------------------------------------------------

2.1 Structural Blueprint
------------------------
The reference image explicitly provides the layout (edges and, if enabled,
depth) that the Canny and Depth ControlNets follow. The generated image is
encouraged to match this geometry — street network, block shapes, building
outlines, relative depth — rather than the geometry of the (possibly
unplanned) input. This removes the prompt–ControlNet conflict and yields
consistent, planned-looking structure in the editable regions.

2.2 Planned-City Archetype
---------------------------
Using an aerial of a planned urban district (e.g. Barcelona Eixample, or any
grid with orthogonal streets and regular blocks) makes the output inherit
that kind of order: orthogonal streets, chamfered blocks, clear boundaries,
internal courtyards. The text prompt can then focus on style and details
(e.g. "modern glass, solar panels, green roofs") without fighting the
underlying structure. The reference answers "what layout?"; the prompt
answers "what appearance?"

2.3 Reproducibility and Reporting
---------------------------------
The pipeline saves the reference and its Canny map to the output directory
for each run:
  - <prefix>_reference.png   — the reference image as used (resized to
                              generation size, e.g. 768×768).
  - <prefix>_reference_canny.png — the exact Canny edge map fed to the
                                  Canny ControlNet.
This allows runs to be reproduced and allows the report to include these
figures with a clear link between the intended layout and the conditioning
signal.

2.4 Optional Use
----------------
The reference is optional. If the user passes --no_reference or does not
provide a path (and no default is found), Canny and depth are derived from
the input image instead. That restores the original "single image" behavior
for cases where the input already has the desired layout.

--------------------------------------------------------------------------------
3. HOW THE REFERENCE IMAGE IS RESOLVED (DEFAULTS AND CLI)
--------------------------------------------------------------------------------

Source: src/generate_satellite_image.py, around lines 1827–1854.

3.1 Resolution Order
--------------------
  (1) If --no_reference is set: reference_image is set to None. Canny and
      depth then use the input image.
  (2) If --reference_image <path> is given: the path is used. If it is
      relative, it is resolved relative to the script directory (src/).
  (3) Otherwise, default path: the project root is found (get_project_root()),
      and DEFAULT_REFERENCE_IMAGE_PATH is used. In the code this is set to
      "reference_image/barcelona_city.jpg" (relative to project root). If
      that file exists, it is used as the reference.
  (4) If that file does not exist: the pipeline looks for the directory
      "reference_image/" under the project root. It picks the first image
      file found (sorted by name) with extension .png, .jpg, .jpeg, .bmp,
      or .tiff and uses it as the reference.
  (5) If no reference is found: reference_image remains None; Canny and
      depth are taken from the input image.

3.2 CLI Arguments
----------------
  --reference_image <path>
    Planned-city (or layout) image for ControlNet structure. Canny and
    depth are derived from this image; inpainting still uses --image and
    --mask. Default: project reference_image/ folder if present.

  --no_reference
    Do not use any reference image; use the input image for ControlNet
    structure (original behavior).

--------------------------------------------------------------------------------
4. HOW THE REFERENCE IMAGE IS USED IN THE PIPELINE (STEP BY STEP)
--------------------------------------------------------------------------------

Source: src/generate_satellite_image.py, around lines 1470–1587.

4.1 Loading Input Image and Mask
--------------------------------
  - load_image_and_mask(image_path, mask_path, size=(args.size, args.size))
    loads the input image (--image) and mask (--mask), resizes both to
    args.size (e.g. 768×768). Returns:
    * original_image — the input image, RGB, resized. This is the inpainting
      base and the source of preserved pixels in the final composite.
    * seg_mask_pil — mask as PIL image (for saving).
    * label_mask — numpy array of class IDs (1–6) per pixel.

  - create_class_masks(label_mask) builds binary masks per class.
  - create_inpainting_mask(class_masks, EDITABLE_CLASSES) produces
    inpaint_mask: white (255) = editable (Residential, Unused, Agricultural),
    black (0) = preserve. Slight boundary erosion is applied to reduce
    bleeding.
  - create_immutable_mask(class_masks, IMMUTABLE_CLASSES) produces
    immutable_mask for compositing: Road, River, Forest.

4.2 Building Control Conditioning: Reference vs Input
----------------------------------------------------
  - ref_path = getattr(args, "reference_image", None).

  If ref_path is set and the file exists:
    (a) reference_image = Image.open(ref_path).convert("RGB").resize(
          (args.size, args.size), Image.Resampling.LANCZOS).
    (b) canny_image = extract_canny_edges(reference_image,
          low_threshold=getattr(args, "canny_low", 50),
          high_threshold=getattr(args, "canny_high", 120)).
        This is the exact map passed to the Canny ControlNet.
    (c) ctrl_for_depth = reference_image (used only if Depth ControlNet
        is enabled).
    (d) The pipeline saves:
        - reference_image → <output_dir>/<stem>_reference.png
        - canny_image    → <output_dir>/<stem>_reference_canny.png

  If ref_path is not set or the file does not exist:
    (a) canny_image = extract_canny_edges(original_image, ...).
    (b) ctrl_for_depth = original_image.
    So Canny and depth conditioning fall back to the input image.

4.3 ControlNet Stack and Order
------------------------------
  control_images = [canny_image]  — always first.
  control_scales = [controlnet_scale]  (e.g. 0.7 or 1.0 from args).

  If Segmentation ControlNet is enabled (default; disable with --no_seg_control):
    seg_image = create_seg_control_image(label_mask).
    control_images.append(seg_image), control_scales.append(seg_scale).
    The segmentation map is built from the input mask's label_mask (ADE20K
    palette), not from the reference. So "where" each class sits (road,
    building, water, etc.) is defined by the input mask.

  If Depth ControlNet is enabled (--use_depth_control):
    depth_image = extract_depth_image(ctrl_for_depth, resolution=args.size).
    control_images.append(depth_image), control_scales.append(depth_scale).
    ctrl_for_depth is either the reference image or the input image,
    depending on whether a reference was provided (see 4.2).

  Final control_image is either a single image (Canny only) or a list
  [canny, seg, depth] for MultiControlNetModel. controlnet_scale is
  either a float or a list of scales matching the number of ControlNets.

4.4 What Does NOT Use the Reference Image
-----------------------------------------
  - Inpainting base: The pipeline receives image=original_image and
    mask_image=inpaint_mask. So the image that is actually edited and the
    regions to regenerate come only from the input image and input mask.
  - Segmentation ControlNet: create_seg_control_image(label_mask) uses
    only the input mask's class labels. The reference image is not involved.
  - Final compositing: composite_with_original(generated_image, original_image,
    inpaint_mask, immutable_mask) copies preserved pixels from original_image
    (the input image), not from the reference.
  - IP-Adapter (if enabled): ip_adapter_image is set to original_image, so
    style/lighting reference also comes from the input, not the reference.

In summary: the reference image is used only to produce the Canny (and
optionally depth) conditioning. It supplies the target structure; the input
image and mask supply the canvas, the inpainting mask, the segmentation
layout, and the preserved pixels.

--------------------------------------------------------------------------------
5. CANNY EDGE EXTRACTION IN DETAIL
--------------------------------------------------------------------------------

Source: extract_canny_edges() in src/generate_satellite_image.py, lines 946–961.

5.1 Purpose
-----------
Extract a white-on-black edge map from an image (either the reference or the
input) for the Canny ControlNet. The ControlNet expects this format to
condition the diffusion process so that the generated image exhibits edges in
similar positions and directions.

5.2 Algorithm
-------------
  - The image is converted to a NumPy array. If it has three channels (RGB),
    it is converted to grayscale (OpenCV COLOR_RGB2GRAY).
  - cv2.Canny(gray, low_threshold, high_threshold) is applied. Default
    thresholds are low=50, high=120 (overridable via --canny_low, --canny_high).
  - The result is a single-channel binary edge map (0 or 255). It is
    converted to a PIL Image in mode "L" and then to RGB (three identical
    channels) because the pipeline typically expects 3-channel conditioning
    images.

5.3 What the Canny Map Encodes
------------------------------
  - Strong edges: street boundaries, block outlines, major roads, river
    edges, large building contours.
  - Finer edges: rooftop boundaries, internal courtyards, smaller
    structures, tree lines.
  The Canny ControlNet (lllyasviel/control_v11p_sd15_canny) uses this map to
  guide the denoising process so that the final image has edges aligned with
  the map. When the reference is a planned city, this map carries the grid,
  chamfered blocks, and boulevard structure into the generation.

5.4 Role of the Saved Canny Image in the Report
-----------------------------------------------
The file <prefix>_reference_canny.png is the exact conditioning signal fed
to the Canny ControlNet. Including both the reference image and this Canny
map in the report shows (1) the intended layout (reference) and (2) the
structural signal the model actually receives (Canny), which helps explain
how the pipeline enforces planned-city geometry.

--------------------------------------------------------------------------------
6. DEPTH EXTRACTION (WHEN DEPTH CONTROLNET IS ENABLED)
--------------------------------------------------------------------------------

Source: extract_depth_image() in src/generate_satellite_image.py, lines 965–976.

6.1 When It Is Used
-------------------
Only when --use_depth_control is passed. By default, Depth ControlNet is
disabled.

6.2 Process
-----------
  - extract_depth_image(image, resolution) uses the controlnet-aux library.
  - MidasDetector.from_pretrained("lllyasviel/ControlNet") loads the
    MiDaS depth estimator.
  - The detector is run on the given image (either the reference or the
    input, i.e. ctrl_for_depth) at the specified resolution (e.g. args.size).
  - The result is a depth map (grayscale or 3-channel for compatibility)
    suitable for the Depth ControlNet (lllyasviel/control_v11f1p_sd15_depth).

6.3 Role
--------
Depth reinforces relative distances and 3D layout. For a top-down aerial,
depth is less dominant than Canny for horizontal layout, but it can still
influence perceived building height and density. When the reference is used
for depth, the planned city's depth structure (e.g. uniform block heights)
can further guide the output.

--------------------------------------------------------------------------------
7. CONTROLNET MODELS AND CONDITIONING SCALES
--------------------------------------------------------------------------------

7.1 Models Loaded (in SmartCitySatelliteGenerator)
--------------------------------------------------
  - Canny:  lllyasviel/control_v11p_sd15_canny  (always loaded).
  - Seg:    lllyasviel/control_v11p_sd15_seg    (unless --no_seg_control).
  - Depth:  lllyasviel/control_v11f1p_sd15_depth (only if --use_depth_control).

  If more than one is loaded, they are wrapped in MultiControlNetModel and
  the conditioning images are passed as a list [canny, seg, depth] in that
  order.

7.2 Conditioning Scales
------------------------
  controlnet_conditioning_scale (or controlnet_scale for Canny) controls how
  strongly each ControlNet influences the generation. Higher values (e.g.
  1.0) enforce structure more; lower values (e.g. 0.6–0.7) give the base
  model more freedom. Defaults are set per ControlNet (e.g. Canny 0.7 or
  1.0, Seg 0.75, Depth 0.6) and can be overridden via CLI.

7.3 Guidance Scheduling
------------------------
  control_guidance_start (default 0.0) and control_guidance_end (default 0.7)
  define the fraction of the denoising steps during which ControlNet is
  applied. Applying ControlNet only for the first 70% of steps allows the
  model to refine details in the later steps while still following the
  reference's structure early on.

--------------------------------------------------------------------------------
8. INPAINTING AND COMPOSITING (CONFIRMING REFERENCE IS NOT USED)
--------------------------------------------------------------------------------

8.1 Inpainting Call
-------------------
  generator.generate_smart_city_image(
    original_image=original_image,   # input image
    control_image=control_image,     # [canny, seg, depth] or canny only
    inpaint_mask=inpaint_mask,
    ...
  )
  Inside the pipeline: image=original_image, mask_image=inpaint_mask,
  control_image=control_image. So the canvas and mask are always the input
  image and the mask derived from the input mask; the reference only affects
  control_image (via the Canny and optionally depth maps derived from it).

8.2 Compositing
---------------
  final_image = composite_with_original(
    generated_image, original_image, inpaint_mask, immutable_mask
  )
  Preserved pixels (immutable mask or outside editable region) are taken
  from original_image. The reference is not used in compositing.

--------------------------------------------------------------------------------
9. OUTPUT FILES RELATED TO THE REFERENCE
--------------------------------------------------------------------------------

When a reference image is used, the pipeline writes:
  - <output_dir>/<prefix>_reference.png      — reference image resized to
                                              generation size (e.g. 768×768).
  - <output_dir>/<prefix>_reference_canny.png — Canny edge map of the
                                              reference; same as the map
                                              passed to the Canny ControlNet.

These can be used directly in the report. Replace <prefix> with your output
prefix (e.g. smart_city_generated).

--------------------------------------------------------------------------------
10. ROLE OF THE CANNY EDGE IMAGE — SUMMARY
--------------------------------------------------------------------------------

The Canny edge image (e.g. smart_city_generated_reference_canny.png) is the
exact conditioning signal fed to the Canny ControlNet. It encodes:
  - Street and block boundaries (strong edges),
  - Building outlines and rooftop contours,
  - Internal features (courtyards, green patches) as finer edges.

The ControlNet guides the diffusion process so that the generated image
exhibits edges in similar positions and directions. Including both the
reference image and its Canny map in the report shows (1) the intended
planned-city layout and (2) the structural signal that the model receives,
making the role of the reference image in ControlNet explicit and
reproducible.

--------------------------------------------------------------------------------
11. LATEX CODE FOR YOUR PROJECT REPORT
--------------------------------------------------------------------------------

Place the reference image and its Canny edge image in your report (e.g. in a
figures/ folder). Adjust the file paths in \includegraphics to match your
layout (e.g. figures/reference.png and figures/reference_canny.png, or
output/smart_city_generated_reference.png and output/smart_city_generated_reference_canny.png).

---BEGIN LATEX---
\documentclass{article}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{float}
\usepackage{url}

\begin{document}

\section*{Significance and Use of the Reference Image in ControlNet}

\subsection*{Problem Addressed}
Our pipeline converts satellite imagery into ``smart city'' style imagery
using Stable Diffusion inpainting conditioned by multiple ControlNets
(Canny, Segmentation, and optionally Depth). The user supplies an input
image and a segmentation mask that define editable regions (Residential
Area, Unused Land, Agricultural Area) and immutable regions (Road, River,
Forest). Initially, structural guidance (Canny edges and depth) was taken
from the same image that was being edited. When that input showed an
unplanned or informal area, the model was asked both to preserve that
chaotic geometry (via ControlNet) and to overwrite it with a planned city
(via the text prompt). This conflict led to weak geometry, muddy details,
and outputs that did not match the desired planned layout. The
\emph{reference image} decouples the desired structure from the input: the
input defines \emph{where} to edit and which regions to preserve; the
reference defines \emph{what layout} to follow for Canny (and optionally
depth) conditioning.

\subsection*{Significance of the Reference Image}
The reference image provides the structural blueprint for generation. We
use an aerial of a planned urban area (e.g.\ Barcelona Eixample--style
grid) so that the Canny and Depth ControlNets condition on that
layout---orthogonal streets, regular blocks, clear boundaries. The text
prompt can then focus on style and details (e.g.\ ``modern glass, solar
panels'') without conflicting with the underlying geometry. The reference
and its Canny map are saved in the output directory
(\texttt{<prefix>\_reference.png} and \texttt{<prefix>\_reference\_canny.png})
for reproducibility and for inclusion in reports.

\subsection*{How the Reference Image Is Resolved}
If \texttt{--no\_reference} is set, no reference is used and Canny/depth
come from the input image. If \texttt{--reference\_image <path>} is given,
that path is used (relative paths are resolved relative to the script
directory). Otherwise, the pipeline uses a default path
(\texttt{DEFAULT\_REFERENCE\_IMAGE\_PATH}, e.g.\
\texttt{reference\_image/barcelona\_city.jpg}) or the first image found
in the project's \texttt{reference\_image/} folder. Only when a valid
reference path exists is the reference image loaded and used for Canny and
depth.

\subsection*{How the Reference Image Is Used in the Pipeline}
In our implementation (\texttt{src/generate\_satellite\_image.py}):

\begin{itemize}
  \item \textbf{Loading:} The reference image is loaded, converted to RGB,
    and resized to the generation size (e.g.\ 768$\times$768).
  \item \textbf{Canny ControlNet:} Canny edges are extracted from the
    reference with configurable low/high thresholds (defaults 50 and 120).
    The result is a white-on-black edge map. This map is the sole
    conditioning for the Canny ControlNet
    (\texttt{lllyasviel/control\_v11p\_sd15\_canny}), so the generated
    image is guided to match the reference's edges (streets, blocks,
    buildings).
  \item \textbf{Depth ControlNet (optional):} If
    \texttt{--use\_depth\_control} is enabled, a depth map is estimated
    from the same reference via controlnet-aux MidasDetector and passed to
    the Depth ControlNet (\texttt{lllyasviel/control\_v11f1p\_sd15\_depth}).
  \item \textbf{What does not use the reference:} The inpainting base and
    mask come from the input image and mask. The segmentation map for the
    Segmentation ControlNet is built from the input mask's class labels
    (\texttt{create\_seg\_control\_image(label\_mask)}), not from the
    reference. Final compositing copies preserved pixels from the input
    image. Thus only Canny (and optional depth) conditioning use the
    reference; the rest of the pipeline uses the input image and mask.
\end{itemize}

If no reference is provided, Canny and depth are derived from the input
image instead.

\subsection*{Role of the Canny Edge Map}
The Canny edge image saved as \texttt{<prefix>\_reference\_canny.png} is the
exact signal fed to the Canny ControlNet. It encodes street and block
boundaries, building outlines, and finer internal edges (courtyards, green
patches). Including both the reference image and this Canny map in the
report shows the intended layout and the structural conditioning the model
receives.

\subsection*{Figures: Reference Image and Its Canny Edge Map}

Figure~\ref{fig:reference} shows the reference image used for structural
conditioning (e.g.\ a planned city aerial). Figure~\ref{fig:reference_canny}
shows the Canny edge map extracted from it; this is the exact signal fed to
the Canny ControlNet.

\begin{figure}[H]
  \centering
  \includegraphics[width=0.85\textwidth]{figures/reference.png}
  \caption{Reference image: planned-city aerial used for ControlNet
    structural conditioning. Loaded, resized to the generation size, and
    used to extract Canny edges (and optionally depth). Saved as
    \texttt{<prefix>\_reference.png} for reproducibility.}
  \label{fig:reference}
\end{figure}

\begin{figure}[H]
  \centering
  \includegraphics[width=0.85\textwidth]{figures/reference_canny.png}
  \caption{Canny edge map of the reference image. White-on-black map
    produced by \texttt{extract\_canny\_edges()} with default thresholds
    (50, 120). This is the exact conditioning passed to the Canny
    ControlNet to guide street layout, block boundaries, and building
    outlines in the generated image. Saved as
    \texttt{<prefix>\_reference\_canny.png}.}
  \label{fig:reference_canny}
\end{figure}

\end{document}
---END LATEX---

Replace \texttt{figures/reference.png} and \texttt{figures/reference\_canny.png}
with your actual paths (e.g.\ \texttt{output/smart\_city\_generated\_reference.png}
and \texttt{output/smart\_city\_generated\_reference\_canny.png}).

================================================================================
